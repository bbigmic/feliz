"use strict";(()=>{var e={};e.id=310,e.ids=[310],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},1764:e=>{e.exports=require("util")},112:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>g,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>m,staticGenerationAsyncStorage:()=>x});var o={};r.r(o),r.d(o,{POST:()=>l});var a=r(9303),s=r(8716),i=r(670),p=r(7070),n=r(3524),d=r(8472);let u=new n.PrismaClient,c=new d.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});async function l(e){let t;let r=await e.text(),o=e.headers.get("stripe-signature");if(!o)return p.NextResponse.json({error:"Brak podpisu"},{status:400});try{t=c.webhooks.constructEvent(r,o,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e),p.NextResponse.json({error:"Nieprawidłowy podpis"},{status:400})}try{switch(t.type){case"checkout.session.completed":let e=t.data.object,r=e.metadata?.orderId,o=e.metadata?.productId,a=e.metadata?.orderType;if(r&&(await u.order.update({where:{id:parseInt(r)},data:{status:"paid"}}),console.log(`Zam\xf3wienie ${r} zostało opłacone`),"demo"===a&&o))try{await u.software.update({where:{id:parseInt(o)},data:{sales:{increment:1}}}),console.log(`Zwiększono licznik sprzedaży dla oprogramowania ${o}`)}catch(e){console.error("Błąd podczas zwiększania licznika sprzedaży:",e)}break;case"checkout.session.expired":let s=t.data.object,i=s.metadata?.orderId;i&&(await u.order.update({where:{id:parseInt(i)},data:{status:"expired"}}),console.log(`Zam\xf3wienie ${i} wygasło`));break;default:console.log(`Nieobsługiwany typ eventu: ${t.type}`)}return p.NextResponse.json({received:!0})}catch(e){return console.error("Błąd podczas przetwarzania webhook:",e),p.NextResponse.json({error:"Błąd serwera"},{status:500})}finally{await u.$disconnect()}}let w=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhook/stripe/route",pathname:"/api/webhook/stripe",filename:"route",bundlePath:"app/api/webhook/stripe/route"},resolvedPagePath:"/Users/bigmic/Desktop/apki/feliztrade/app/api/webhook/stripe/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:m}=w,k="/api/webhook/stripe/route";function g(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:x})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[276,972,472],()=>r(112));module.exports=o})();